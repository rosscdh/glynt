{% extends 'document/base.html' %}
{% load i18n markup sign_tags templatetag_handlebars glynt_helpers %}
{% load url from future %}

{% block owner_info %}
<div class="">
  <h2 id="document-title" class="editable">{{ userdoc.name }}</h2>
</div>
{% endblock %}


{% block document %}
<div class="row">
  <ul id="progress"></ul>
  <div id="document">{% show_loading modal='False' %}</div>
</div>
{% endblock %}


{% block css %}
<style>

.doc_var{
  background-color:#c00;
  color:#000;
}
  
</style>
{% endblock %}

{% block js %}
<script src="{{ STATIC_URL }}js/jquery.jeditable.mini.js"></script>
<script type="text/x-handlebars-template" id="document-hb">
{{ userdoc.body|default:object.body|safe }}
</script>

<script>
// -- Functionality --
Handlebars.registerHelper('doc_var', function(context, options) {
  if (context.hash.name == undefined || context.hash.name == '') {
    throw 'doc_var requires a "name"';
  };
  var app = (context.hash.app == undefined) ? window.app : eval('window.'.format(context.hash.app)) ;
  var var_name = context.hash.name;
  var field_type = 'text';

  if (context.hash.field_type != undefined && context.hash.field_type == '') {
    field_type = context.hash.field_type;
  }
  // see if this context.name is already defined in the app context (to get user populated data)
  var value = (context.hash.initial != undefined) ? context.hash.initial : '_____'.repeat(2) ;
  value = (app.context[var_name] == undefined) ? value : app.context[var_name] ;

  if (app.context[var_name] == undefined) {
    // set to nul because we know it is undefined; assert positive
    app.context[var_name] = null;
  };
  // wrap the value in our detailed html to allow UX interaction
  var html_return = '<span class="{type}" data-doc_var="{variable_name}">{value}</span>'.assign({ variable_name: var_name, value: value, type: 'doc_var' });

  context.hash.field_type = field_type;
  context.hash.html_return = html_return;
  // set the context
  app.helper_context[var_name] = context.hash;

  // make it safe so hb does not mess with it
  return new Handlebars.SafeString(html_return);
});
Handlebars.registerHelper('doc_or', function(context, options) {
  if (context.hash.name == undefined || context.hash.name == '') {
    throw 'doc_or requires a "name"';
  };
  var app = (context.hash.app == undefined) ? window.app : eval('window.'.format(context.hash.app)) ;
  var var_name = context.hash.name;

  // wrap the value in our detailed html to allow UX interaction
  var html_return = '<span class="{type}" data-doc_or="{variable_name}" data-doc_or_group="{var_group}">'.assign({ variable_name: var_name, type: 'doc_var' });
  return new Handlebars.SafeString(html_return);
});
</script>

<script>
{% include 'smoothe/document.js' %}
</script>
{% endblock %}