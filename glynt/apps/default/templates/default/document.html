{% extends 'default/base.html' %}
{% load i18n markup templatetag_handlebars %}
{% load url from future %}

{% block form %}
<form class="bind-document">
	<input type="hidden" class="md-updater" data-hb-name="title" placeholder="Contract for Assassination" name="" id="" value=""/>
	<input type="text" class="md-updater" data-hb-name="contractor" placeholder="Your Name" name="" id="" value=""/>
	<input type="text" class="md-updater" data-hb-name="target" placeholder="Who you want to assasinate" name="" id="" value=""/>
	<input type="text" class="md-updater" data-hb-name="date_by" placeholder="By when?" name="" id="" value=""/>
	<input type="text" class="md-updater" data-hb-name="willing_to_pay" placeholder="1000.00" name="" id="" value=""/>
</form>
{% endblock %}

{% block document %}
<span id="document-md" data-bind="with: App"></span>
{% endblock %}


{% block js %}

{% include document %}

<script type="text/javascript">
$(document).ready(function(){

	function DocumentModel() {
		var self = this;

		self.handlebarsElementId = ko.observable('script#js-{{ doc }}');
		self.documentTemplate = ko.observable($(self.handlebarsElementId()).html());

		self.context = ko.observable({});

		self.setContextItem = function setContextItem(key,value) {
			var context = self.context();
        	context[key] = value;
        	self.context(context);
		}

		self.getContext = function getContext() {
			return self.context();
		}

        self.render = function render() {
        	var context = self.context();
		    var source   = self.documentTemplate();
			var template = Handlebars.compile(source);
			return template(context);
        }
	}

    /**
    * Primary view acts as a holder for the other views
    */
    function PageDocumentController() {
        var self = this;

        self.markdownConverter = new Markdown.Converter();
        self.targetDocumentId = ko.observable('span#document-md');
        self.documentModel = new DocumentModel();

        self.init = function init() {

        	var name = null;
        	var value = null;
        	$.each($('form.bind-document'), function(index, form) {
        		$.each($(this).find('input'), function(index, input) {
        			name = $(input).attr('data-hb-name');
        			value = $(input).attr('placeholder');
        			value = '**' + value.toString() + '**';
        			self.documentModel.setContextItem(name, value);
        		});
        	});

        	self.render();
        }

        self.render = function render() {
        	var md = self.documentModel.render();
        	var html = self.renderMarkdown(md);

        	$(self.targetDocumentId()).html(html);

        }
        self.renderMarkdown = function render(md) {
        	return self.markdownConverter.makeHtml(md);
        }

        self.init();
    }

    // ----- KO Instance -----
    App = new PageDocumentController()
    // ----- KO Bindings -----
    ko.applyBindings(App);

    $('input.md-updater').live('change', function(event){
    	var name = $(this).attr('data-hb-name');
    	var value = $(this).val();
    	App.documentModel.setContextItem(name, value);
    	App.render();
    })
});
</script>

{% endblock %}