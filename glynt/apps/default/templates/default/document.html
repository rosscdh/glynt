{% extends 'default/base.html' %}
{% load i18n markup templatetag_handlebars %}
{% load url from future %}

{% block form %}
<form class="bind-document">{% csrf_token %}
    <div class="row">
    <div class="controls pull-right">
        <span data-bind="visible: App.formControls.showPrev()"><button id="btn-prev" class="btn btn-primary btn-mini btn-prev" type="button" data-bind="click: App.formControls.prev">Previous</button></span>
        <span data-bind="visible: App.formControls.showNext()"><button id="btn-next" class="btn btn-primary btn-mini btn-next" type="button" data-bind="click: App.formControls.next">Next</button></span>
    </div>
    </div>
    {% for form in form_set %}
    <div id="form-group-{{ forloop.counter }}" class="form-group {% if not forloop.first %}hidden{% endif %}">
        <h4>Step {{ forloop.counter }}. of {{ form_set|length }}</h4>
        <h4><span class="step-title"></span></h4>
        <br/>
        {{form}}
    </div>
    {% if forloop.last %}
    {% endif %}
    {% endfor %}
    <div id="form-group-{{ form_set|length }}" class="form-group hidden" data-bind="visible: App.formControls.isLastStep()">
        <div class="span3">
            <button id="btn-post-pdf" class="btn btn-success" type="button" data-bind="click: App.postDocument">Get Contract</button>
        </div>
    </div>
</form>
{% endblock %}

{% block document %}
<span id="document-md" data-bind="html: App.documentModel.renderedHTML()"></span>
{% endblock %}

{% block css %}
<style>
.hidden {
    display:none;
}
form div.form-group ul{
    list-style-type: none;
    list-style: none;
}
span.helptext {
display:none;
}
</style>
{% endblock %}

{% block js %}

{% include document %}

<script type="text/javascript">
$(document).ready(function(){

    function FormControls() {
        var self = this;

        self.actualFormSteps = ({{form_set|length}}+1);// account for end form
        self.maxFormSteps = ko.observable(({{form_set|length}}+1));// account for end form
        self.currentFormStep = ko.observable(1);

        self.showNext = function showNext() {
            return (self.currentFormStep() == self.maxFormSteps())? false : true ;
        }
        self.showPrev = function showPrev() {
            return (self.currentFormStep() == 1)? false : true ;
        }
        self.isLastStep = function isLastStep() {
            return (self.maxFormSteps() == self.currentFormStep()) ? true : false ;
        }

        self.determineNextStepIndex = function determineNextStepIndex(direction,next_step) {
            var ruleset = App.documentModel.getRuleByType('show_step_when');
            ruleset = ruleset[0];
            var target_element = $(ruleset.target_element);
            var target_element_step_id = target_element.attr('id').replace(/[^\d]+/ig, '');

            //@TODO basis for the ruleset evaluation routine
            for (var i=0; i < ruleset.ruleset.length; i++) {
                for (context_var_name in ruleset.ruleset[i]) {
                    var required_value = ruleset.ruleset[i][context_var_name];
                    if (context_var_name in App.documentModel.context()) {
                        var current_context_value = App.documentModel.context()[context_var_name];

                        //console.log(context_var_name+': '+required_value +'=='+ current_context_value)

                        if (required_value != current_context_value && target_element_step_id == next_step) {
                            
                            if (direction == 'next') {
                                next_step++;
                            }else{
                                next_step = next_step - 1;
                            }
                            // the ruleset matches 1 or more of the rules
                            // and the step about to be shown is indeed the target step
                            return next_step;
                        }
                    }
                }
                
            }
            return next_step;
        }

        self.determineStepVisibility = function determineStepVisibility(direction,step) {

            step = self.determineNextStepIndex(direction,step);

            $.each($('div.form-group'), function(index,form_group){
                form_group = $(form_group);

                if ((index+1) == step) {
                    form_group.css('display', 'block');
                    form_group.removeClass('hidden');
                }else{
                    form_group.css('display', 'none');
                    form_group.addClass('hidden');
                }
            });
            return step;
        }

        self.next = function next() {
            var current = self.currentFormStep();
            var next = current+1;

            next = self.determineStepVisibility('next',next);
            self.currentFormStep(next);
        }
        self.prev = function prev() {
            var current = self.currentFormStep();
            var prev = current-1;

            prev = self.determineStepVisibility('prev',prev);

            self.currentFormStep(prev);
        }
    }

	function DocumentModel() {
		var self = this;

        self.textElementsList = ['text','textarea','hidden','select'];
        self.FalseValuesList = ['False','false',false,null,void 0,''];
		self.handlebarsElementId = ko.observable('script#js-{{ doc }}');
		self.documentTemplate = ko.observable($(self.handlebarsElementId()).html());
		self.renderedHTML = ko.observable('');
        self.visibilityRuleset = ko.observableArray([]);

        function Rule(element,target_element,ruleset){
            var self = this;
            self.element = (element != undefined)?element:null,
            self.target_element = (target_element != undefined)?target_element:null,
            self.ruleset = (ruleset != undefined)?ruleset:[]
        };

        self.ruleSet = ko.observable({
            'show_step_when': [],
            'show_element_when': []
        });

		self.context = ko.observable({
		    'company': {
		        'name': 'RuleNo1',
		        'url':'http://www.ruleno1.com'
		    },
		    'document': {
		        'title': '{{ object.name }}'
		    }
		});

        self.getRuleByType = function getRuleByType(ruleset_type) {
            if (ruleset_type in self.ruleSet()) {
                return self.ruleSet()[ruleset_type];
            }
            return false;
        }

        self.setRule = function setRule(element,ruleset) {
            var rule = new Rule(element);
            for (r in self.ruleSet()) {
                if (r in ruleset) {
                    if (r == 'show_step_when') {
                        rule.target_element = $(element.closest('div.form-group')[0]);
                    }
                    rule.ruleset.push(ruleset[r]);
                    self.ruleSet()[r].push(rule);
                }
            };
        }

        self.slugify = function slugify(text) {
            if (typeof text == 'boolean') {
                text = (text === true)?'true':'false';
            }else{
                text = text.replace(/[^_-a-zA-Z0-9,&\s]+/ig, '');
                //text = text.replace(/-/gi, "_");
                text = text.replace(/\s/gi, "-");
            }
            return text.toLowerCase();
        }

        self.assertElementIsVisibleWhen = function assertElementIsVisibleWhen(key, value) {
            if (key in self.context()) {
                var context_value = self.context()[key];
                if (context_value == value) {
                    return true;
                }else{
                    // hide the relavant object
                }
            }
            return false;
        }

        self.determineValue = function determineValue(input) {
			var value = null;
			var is_placeholder_value = true;
			if (input.val() != 'undefined' && input.val() != '') {
			    value = input.val();
			    is_placeholder_value = false;
			}else{
			    value = input.attr('placeholder');
		    }

            if (self.textElementsList.indexOf(input.attr('type')) >= 0) {
                //if (is_placeholder_value === true) {
                    value = '_**' + value.toString() + '**_';
                //}
            }

            if (self.textElementsList.indexOf(input.attr('type')) == -1) {
                
                if (input.attr('type') == 'checkbox') {
                    value = (input.attr('checked') == 'checked') ? true : false ;
                    self.setTemplateHelperValues(input);
                }
                if (input.attr('type') == 'radio') {
                    value = false;
                    if (input.attr('checked') == 'checked') {
                        value = input.val();
                        self.setTemplateHelperValues(input);
                    }
                }
            }

            self.setTemplateHasHelperValues(input, value, is_placeholder_value);

            return value;
        }

        self.setTemplateHasHelperValues = function setTemplateHasHelperValues(input, value, is_placeholder_value) {
            var key = 'has_' + input.attr('data-hb-name');
            var has_this_value = (self.FalseValuesList.indexOf(value) >= 0 || is_placeholder_value === true)? false : true ;
            self.setContextItemByForce(key, has_this_value);
        }

        self.setTemplateHelperValues = function setTemplateHelperValues(input) {
            // set custom
            var value = input.val();
            var slug = self.slugify(input.attr('data-hb-name'));
            var value_slug = self.slugify(value);
            var key = '_' + slug + '_' + value_slug;
            var found = false;

            self.setContextItemByForce(key, true);

            for (context_key in self.context()) {
                if (context_key.indexOf(slug) >= 0) {
                    // found it
                    if (context_key != key) {
                        self.setContextItemByForce(context_key, false);
                    }
                }
            }
        }

		self.setContextItem = function setContextItem(input) {
            // only allow if the data-hb-name is set
            if (typeof input.attr('data-hb-name') == 'string') {
    			var context = self.context();
    			var key = name = input.attr('data-hb-name');
    			var value = self.determineValue(input);

            	context[key] = value;
            	self.context(context);
            }
		}

        self.setContextItemByForce = function setContextItemByForce(key,value) {
            var context = self.context();
            context[key] = value;
            //console.log('Force - key: '+key+' value:'+value)
            self.context(context);
        }

        self.render = function render() {
        	var context = self.context();
		    var source   = self.documentTemplate();
			var template = Handlebars.compile(source);
			return template(context);
        }
	}

    /**
    * Primary view acts as a holder for the other views
    */
    function PageDocumentController() {
        var self = this;

        self.markdownConverter = new Markdown.Converter();
        self.targetDocumentId = ko.observable('span#document-md');
        self.documentModel = new DocumentModel();
        self.formControls = new FormControls();

        self.setGlyntRuleset = function setGlyntRuleset() {
            // loop over lements looking for rulesets
            $('form.bind-document input[data-glynt-rule]').each(function(index,element){
                var rules = eval($(element).attr('data-glynt-rule'));
                rules = rules[0];// javascript json weirdness
                self.documentModel.setRule($(element), rules);
            });
        }

        self.setContext = function setContext() {
            // loop over all valid form elements and set them in the context
            var name = null;
            var value = null;

            $.each($('form.bind-document'), function(index, form) {
                $.each($(this).find('input'), function(index, input) {
                    self.documentModel.setContextItem($(input));
                });
                $.each($(this).find('textarea'), function(index, input) {
                    self.documentModel.setContextItem($(input));
                });
                $.each($(this).find('select'), function(index, input) {
                    self.documentModel.setContextItem($(input));
                });
            });
        }

        self.init = function init() {
            // main initializer
            self.setContext();
            self.setGlyntRuleset();
        	self.render();
        }

        self.render = function render() {
        	var md = self.documentModel.render();
        	var html = self.renderMarkdown(md);

        	//$(self.targetDocumentId()).html(html);
        	self.documentModel.renderedHTML(html)

        }
        self.renderMarkdown = function render(md) {
        	return self.markdownConverter.makeHtml(md);
        }

        self.changeContext = function changeContext(input) {
            self.documentModel.setContextItem(input);
            self.render();
        }

        self.postDocument = function postDocument() {

            var csrf_token = $('form.bind-document:first').find('input[type=hidden]:first')
            var data = {
                csrfmiddlewaretoken: csrf_token.val(),
                md: self.documentModel.render()
            };

            $.ajax({
              type: 'POST',
              url: "{% url 'document:export' doc=doc %}",
              data: data,
            })
            .success(function(data, textStatus, jqXHR) {
            })
            .error(function() { 
            })
            .complete(function() {});
        }

        self.init();
    }

    // ----- KO Instance -----
    App = new PageDocumentController()
    // ----- KO Bindings -----
    ko.applyBindings(App);

    $('.md-updater').live('mouseout', function(event){
    });

    $('form.bind-document span.step-title').each(function() {
        var element = $(this).closest('div').find('input[data-step-title]');
        $(this).text(element.attr('data-step-title'));
    });

    $('.md-updater').live('change', function(event){
    	var name = $(this).attr('data-hb-name');
    	var value = $(this).val();
        App.changeContext($(this));
        //console.log(App.documentModel.context())
    })
});
</script>

{% endblock %}