{% extends 'base.html' %}{% load crispy_forms_tags invite_tags account_tags jsonify glynt_helpers %}

{% block page_title %}Edit your Account details{% endblock %}
{% block bodyclass %}startup-form{% endblock %}
{% block prebody %}
<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}/css/theme/social-buttons.css">
<div id="hero">
    <div class="container">
        <div class="row">
            <div class="span12">
                <h1>Update your profile</h1>
            </div>
        </div>
    </div>
</div>
<div class="container profile">

    <div class="alert alert-error hidden">Please correct all errors before submitting the form</div>

    <div class="row">
        <div class="span12">
            <ul id="profile-tab" class="nav nav-tabs">
                <li class="active"><a href="#account" data-toggle="tab">Account</a></li>
                <li><a href="#password" data-toggle="tab">Password</a></li>
                <li><a href="#organization" data-toggle="tab">Organization</a></li>
            </ul>

            <form id="customer-profile-form" data-validate="parsley" action="{% url 'customer:setup_profile' %}" method="POST" class="form-horizontal" enctype="multipart/form-data">{% csrf_token %}
                <div class="tab-content">

                    <div id="account" class="tab-pane active">
                        <div class="row">
                            <div class="span12">
                                <legend>Account</legend>
                            </div>
                        </div>
                        <div class="row">
                            <div class="span2">
                                <div class="control-group">
                                   <div class="">
                                        <img id="photo-preview" class="" vspace="10" width="130" height="130" src="{{ customer.profile_photo }}">
                                    </div>
                                    <div class="">
                                        {{ form.photo.errors }}
                                        <div class="input">
                                            {{ form.photo }}
                                            {{ form.hidden_photo }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="span9">
                                <div class="control-group">
                                    {{ form.first_name|as_crispy_field }}
                                </div>
                                <div class="control-group">
                                    {{ form.last_name|as_crispy_field }}
                                </div>
                                <div class="control-group">
                                    {{ form.email|as_crispy_field }}
                                </div>
                                <div class="control-group">
                                    {{ form.phone|as_crispy_field }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="password" class="tab-pane">
                        <div class="row">
                            <div class="span12">
                                <legend>Password</legend>
                            </div>
                        </div>
                        <div class="row">
                            <div class="control-group">
                                {{ form.old_password|as_crispy_field }}
                            </div>
                            <div class="control-group">
                                {{ form.new_password|as_crispy_field }}
                            </div>
                            <div class="control-group">
                                {{ form.confirm_password|as_crispy_field }}
                            </div>
                        </div>
                    </div>

                    <div id="organization" class="tab-pane">
                        <div class="row">
                            <div class="span12">
                                <legend>Organization</legend>
                            </div>
                        </div>
                        <div class="row">
                            <div class="span6">
                                <div class="control-group">
                                    {{ form.company_name|as_crispy_field }}
                                </div>
                                <div class="control-group">
                                    {{ form.summary|as_crispy_field }}
                                </div>
                            </div>
                            <div class="span5">
                                <div class="control-group">
                                    {{ form.website|as_crispy_field }}
                                </div>
                                <div class="control-group">
                                    {{ form.twitter|as_crispy_field }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="form-submit" class="row">
                        <div class="span12 divide">
                            <div class="form-actions">
                            <label class="checkbox">
                                {{ form.agree_tandc|as_crispy_field }}
                                <span id="i_agree_html">I agree to the LawPal <a href="{% url 'public:terms' %}">Terms and Conditions</a></span>
                            </label>

                                <button id="update-profile" type="submit" class="btn btn-primary btn-large">Update Profile</button>
                            </div>
                        </div>
                    </div>

                </div>
            </form>

        </div>
    </div>
</div>

{% endblock %}

{% block css %}
<style>
.border{
    border:solid #c00 1px;
}
    img#photo-preview{
        border:solid #ccc 2px;
        min-height: 50px;
        min-width: 50px;
        max-height: 130px;
        max-width: 130px;
    }
    .hidden { display: none; }
    #id_incubator_or_accelerator_name {
        margin-top:-15px;
    }
    .logo-head{
        margin-top:40px;
        float:left;
    }
    h1 {
        margin-top:80px;
        font-size:50px;
        color:#ccc;
    }
</style>
{% endblock %}

{% block js %}
<!-- # include cicu etc -->
{{ form.media }}

<script>
function preparePhotoPreview(element) {
    var element = $('.cropped-imag-preview');
    var cookie_data = $.parseJSON($.cookie('startup_profile_photo-{{ customer.pk }}'));

    $.each(element.find('img'), function(i,img){
        img = $(img)
        src = img.attr('src');

        photo_id = null;

        /**
        * Stores the photo ID in a field
        */
        if (cookie_data && cookie_data.id !== undefined) {
            photo_id = cookie_data.id;
            $('#id_hidden_photo').val(photo_id);
            //src = cookie_data.path;
        }

        if (src) {
            $('#photo-preview').attr('src', src)
        }

        img.hide();
    })
}

function photoCrop(element, data) {
    $('#id_hidden_photo').val(data.id);// id to be sent
    $.cookie('lawyer_profile_photo-{{ user.pk }}', JSON.stringify({'id': data.id, 'path': data.path}));
    preparePhotoPreview(element);
}

$(document).ready(function() {
   /**
    * Tabination
    */
    $('ul#profile-tab li a').click(function (e) {
        e.preventDefault();
        $(this).tab('show');
    });

    /**
    * Parsley error counter
    */
    var handleErrorCount = function handleErrorCount(tabPane) {

        var targetTabLink =  $('#profile-tab a[href="#{id}"]'.assign({
            id: tabPane.prop('id')
        }));

        var targetTabLi = targetTabLink.closest('li');
        var errorCount = parseInt(tabPane.find('.parsley-error').length);

        tabPane.attr('data-error-count', errorCount);
        targetTabLi.find('em').remove();

        if (errorCount > 0) {
            var errorTemplate = $('<em/>', {
                html: '<span>{errorCount}</span>'.assign({'errorCount': errorCount})
                ,class: 'unread_counter animated bounce'
            });
            targetTabLink.append(errorTemplate);
        }
    };
    /**
    * Parsley error catcher
    */
    $( 'form[data-validate="parsley"]' ).parsley( 'addListener', {
        onFormSubmit: function ( isFormValid, event, ParsleyForm ) {
            if (isFormValid === false) {
                // Scroll to top ONLY on error
                $("html, body").animate({scrollTop: 200}, 1000);

                // get the nearest tabPane to store error count unless error is from T&Cs checkbox
                $.each($('.tab-pane[data-error-count]'), function(i,elem){
                    var tabPane = $(elem);
                    // this event must fire once all of the .parsley-errors
                    // have been created (onFieldError)
                    handleErrorCount(tabPane);
                })

                $('.alert-error').removeClass('hidden');
            } else {
                $('.alert-error').addClass('hidden');
            }
        },
        onFieldError: function ( elem, constraints, ParsleyField ) {
            elem = $(elem);

            if (elem.prop('id') !== 'id_agree_tandc') {
                var tabPane = $(elem.closest('.tab-pane'));
                // increment the error count attrib
                var errorCount = tabPane.attr('data-error-count');
                if (errorCount == 0) {
                    errorCount = parseInt(errorCount) + 1;
                    tabPane.attr('data-error-count', errorCount)
                }
            }

            if ( !elem.is( ':visible' ) ) {
                return true;
            }
            return false;
        }
        , onFieldSuccess: function ( elem, constraints, ParsleyField ) {
            // get the nearest tabPane to store error count unless error is from T&Cs checkbox
            if ($(elem).prop('id') !== 'id_agree_tandc') {
                var tabPane = $(elem).closest('.tab-pane');
                handleErrorCount(tabPane)
            }
        }
    });

    /** show the tab with errors **/
    $('#update-profile').click(function(e) {
        /** hack to wait for DOM to update **/
        window.setTimeout(removeTab, 0);

        function removeTab() {
            $('#profile-tab').find('.unread_counter').first().parent().trigger('click');
        }
    });

    /** stop the form submitting on enter, must push de button */
    $('form#customer-profile-form').bind("keypress", function(e) {
        if (e.keyCode == 13) {
            e.preventDefault();
            return false;
        }
    });
});
</script>

{% endblock %}
