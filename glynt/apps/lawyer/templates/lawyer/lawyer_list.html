{% extends 'base.html' %}{% load crispy_forms_tags %}

{% block page_title %}Marketplace{% endblock %}
{% block bodyclass %}lawyer-welcome{% endblock %}


{% block prebody %}
<link rel="stylesheet" href="{{ STATIC_URL }}css/theme/lawyer-listing.css" type="text/css">

    
<div id="hero">
	<div class="container">
		<!-- starts carousel -->
		<div class="row animated fadeInDown">
			<div class="span12">
				<h1>Find a lawyer for your startup</h1>
			</div>
		</div>
		<div class="dock">
            <form id="lawyer-list-form" data-validate="parsley" action="{% url 'lawyer:list' %}" method="GET" class="form-inline">{% csrf_token %}
                We need a lawyer in {{ form.location|as_crispy_field }} <span id="rotate"></span> {{ form.q|as_crispy_field }}
                <span class="rotate">for</span>
                <span class="rotate">that does</span>
                <span class="rotate">who can do</span>
                <span class="rotate">that works at</span>
                <br />
                <br />
                <button class="btn btn-large submit" type="submit" id="lawyer-list-filter">Show Lawyers</button>
            </form>
		</div>
	</div>
</div>

{% endblock %}

{% block body %}

{% include page_template %}

{% endblock %}

{% block css %}
{{ block.super }}
<style>
    span#rotate {
        width:160px;
    }
    span.rotate {
        display:none;
    }
</style>
{% endblock %}

{% block js %}
{{ block.super }}
<script id="controls-search">

$(document).ready(function(){

    $('form#lawyer-list-form input').live('click', function(event){
        $(this).select()
    });
    $('button#lawyer-list-filter').live('click', function(event){
        event.preventDefault();
        var form = $( 'form#lawyer-list-form' );

        if (form.parsley( 'validate' )) {
            params = {}
            // remove items with no value
            $.each({
                'q': encodeURIComponent($('#id_q').val())
                ,'location': encodeURIComponent($('#id_location').val())
            }, function(k,val){
                //if (val != '') {
                    params[k] = val;
                //}
            });

            document.location = form.attr('action') + '?{params}'.assign({'params': $.param(params) });
        }
    });


    /**
    * Dynamic selector functions based on form api urls
    * @TODO unify this with profile form
    */
    ajax_lookup = function(url, filter, callback) {
        var object_list = []
        url = (filter === undefined)? url: url + '&' + filter;
        console.log(url)
        $.ajax({
            type: 'GET',
            url: url,
            data: null,
            beforeSend: function(jqXHR, settings) {
                // Pull the token out of the DOM.
                jqXHR.setRequestHeader('X-CSRFToken', $('input[name=csrfmiddlewaretoken]').val());
            },
            success: function(data, textStatus, jqXHR){
                $.each(data.objects, function(i,item){
                    object_list.push(item.name)
                })
                // call the calling callback.. javascript
                callback(object_list);
            },
            error: function(data, textStatus, jqXHR){
                console.log(jqXHR)
                console.log(textStatus)
            }
        });
    }

    /**
    * handle typeahead requests
    */
    $.each($('[data-provide=ajax]'), function(i, element) {
        var e = $(element);

        e.typeahead({
            source: function(query, process_callback) {
                var provide = e.attr('data-provide');
                var url = e.attr('data-source');
                var filter = e.attr('data-filter');
                filter = (filter === undefined)? filter : filter + '=' + query ;
                ajax_lookup(url, filter, process_callback);
            }
            ,limit: 15
        });
    });

    /**
    * term rotator - for lawyer search form
    * @TODO turn into object
    */
    $('form#lawyer-list-form').delegate(':input', 'blur', function(event){
        //console.log('start')
        window.startRotator();
    });
    $('form#lawyer-list-form').delegate(':input', 'focus', function(event){
        //console.log('stop')
        window.stopRotator();
    });
    pauseRotator = false;
    startRotator = function startRotator() {
        pauseRotator = false;
        $(termRotator);
    }
    stopRotator = function stopRotator() {
        pauseRotator = true;
        $("#rotate").clearQueue();
    }
    var termRotator = function termRotator() {
        var ct = $("#rotate").data("term") || 0;
        var terms = $('span.rotate');

        if (pauseRotator === true) {
            $("#rotate").data("term", 0).text($(terms[ct]).text()).show();
            return;
        }
        $("#rotate").data("term", ct == terms.length -1 ? 0 : ct + 1).text($(terms[ct]).text()).fadeIn().delay(2000).fadeOut(200, termRotator);
    }
    $(termRotator);
});
</script>
<script src="{{ STATIC_URL }}endless_pagination/js/endless-pagination.js"></script>
<script>
    $.endlessPaginate({
        paginateOnScroll: true
        ,paginateOnScrollMargin: 60
        ,paginateOnScrollChunkSize: 5
    });
</script>
{% endblock %}