{% load i18n todo_tags glynt_helpers %}
<h4 class="softer"><i class="glyphicon glyphicon-file" style="font-size:15px"></i> {{ object.filename }}</h4>
<!-- if we have a lawyer involved in this project -->
{% if has_lawyer %}
    <!-- if there is a feedback request in action -->
    {% for f in feedback_requests %}        
        {% if f.assigned_by == user %}
            <div class="alert alert-block alert-info text-center">
                <div class="row">
                    <div class="col-9">
                        <p>You have requested feedback from {{ f.primary_assigned_to.get_full_name|default:f.primary_assigned_to.username }} on this attachment.</p>
                    </div>
        {% else %}
            <div class="alert alert-block alert-alert text-center">
                <div class="row">
                    <div class="col-9">
                        <!-- <div class="profile-card" data-template="mini" data-username="{{ f.assigned_by.username }}" data-img_class="img-circle"></div> -->
                        <p>{{ f.assigned_by.get_full_name|default:f.assigned_by.username }} has requested your feedback on this attachment. Please review the document below, add comments if required and click 'Feedback Complete'</p>
                    </div>
        {% endif %}

                    {% if f.status == FEEDBACK_STATUS.open %}
                        <button class="btn btn-success pull-right" data-href="/api/v1/feedback_request/{{ f.pk }}" data-toggle="modal" data-target="#modal-feedback-form" data-is_ajax="false" data-pk="{{ f.pk }}" data-attachment="{{ object.pk }}" data-assigned_by="{{ user.pk }}" data-assigned_to="{{ opposite_user.pk }}" data-status="{{ FEEDBACK_STATUS.closed }}">{% if f.assigned_by == user %}Cancel Request{% else %}<i class="glyphicon glyphicon-ok"></i> Feedback Complete{% endif %}</button>
                    {% endif %}
             </div>
         </div>
    {% empty %}
        <!-- if no feedback request present -->
        <!-- and is_customer or is_lawyer -->
        <button class="btn btn-primary pull-right" data-href="/api/v1/feedback_request" data-toggle="modal" data-target="#modal-feedback-form" data-attachment="{{ object.pk }}" data-assigned_by="{{ user.pk }}" data-assigned_to="{{ opposite_user.pk }}" data-status="{{ FEEDBACK_STATUS.open }}">Request Feedback</button>
    {% endfor %}
{% endif %}

{% if not feedback_requests %}
<div class="row">
    <div class="btn-group pull-right">
        {% if object.uploaded_by == user or is_lawyer %}<button class="btn btn-delete-attachment btn-link pull-right" data-pk="{{ object.pk }}">Delete</button>{% endif %}
        <button class="btn btn-fullscreen btn-link pull-right">Full Screen</button>
    </div>
</div>
{% endif %}
<br />
<iframe id="crocdoc-viewer-iframe" src="{{ view_url }}" width="100%" height="550px" frameborder="none" style="margin-top:5px;"></iframe>

<script type="text/javascript">
$(document).ready(function () {
    
    $(document).on( 'click', '.btn-fullscreen', function (event) {
        event.preventDefault();
        var url = $('#crocdoc-viewer-iframe').attr('src');
        if ( url ) {
            window.open(url, 'crocdoc-fullscreen', 'width={width}, height={height}, left=0, top=0, scrollbars=yes, fullscreen=yes'.assign({'width': window.width, 'height':  window.height}));
        }
    });

    $(document).on( 'click', '.btn-delete-attachment', function (event) {
        event.preventDefault();

        var elem = $(this);
        var pk = elem.data('pk');

        elem.fadeOut('slow');

        var url = '/api/v1/attachment/{pk}'.assign({'pk': pk});
        var data = {
            'deleted_by': {'pk': '{{ user.pk }}'}
        };

        $.ajax({
            type: 'DELETE',
            url: url,
            data: JSON.stringify(data),
            dataType: 'application/json',
            contentType: 'application/json',
            beforeSend: function (jqXHR, settings) {
                // Pull the token out of the DOM.
                jqXHR.setRequestHeader('X-CSRFToken', $('input[name=csrfmiddlewaretoken]:first').val());
            },
            complete: function () {
                loadAttachments();
            }
        });

    });
});
</script>