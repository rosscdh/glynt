{% extends 'document/base-left.html' %}
{% load i18n markup %}
{% load sign_tags %}
{% load glynt_helpers document_tags %}
{% load url from future %}

{% block bodyclass %}review{% endblock %}

{% block owner_info %}
<div class="span12">
  <h2 id="document-title">{% trans 'Review:' %} {{ userdoc.name }}</h2>
</div>
{% endblock %}

{% block form %}

<div class="span3 sidebar">
  <ul class="nav nav-list">
    <li><a href="#/review" class="btn btn-success"><i class="icon-bookmark"></i>{% trans 'Review Document' %}</a></li>
    <li class="divider"></li>
    <li><a href="{% url 'doc:update_document' pk=userdoc.pk %}" class="btn"><i class="icon-edit"></i>{% trans 'Edit Doc' %}</a></li>
    <li class="divider"></li>
    <li><a id="export-{{ d.pk }}" href="{% url 'export:as_pdf' slug=userdoc.slug %}" class="btn" target="_BLANK" data-url="{% url 'export:as_pdf' slug=userdoc.slug %}" data-pk="{{ userdoc.pk }}" class=""><i class="icon-download"></i>{% trans 'Download PDF' %}</a></li>
    <li class="divider"></li>
        <li><a href="#/review/qr" class="btn"><i class="icon-qrcode"></i>{% trans 'QR Code' %}</a></li>
    <li class="divider"></li>
      <li><a href="#/review/signatories" class="btn"><i class="icon-pencil"></i>{% trans 'Signature Details' %}</a></li>
    <li class="divider"></li>
      <li><a href="#/review/comments" class="btn"><i class="icon-comment"></i>{% trans 'Comments' %}</a></li>
    <li class="divider"></li>
      <li><a href="#/review/activity" class="btn"><i class="icon-list"></i>{% trans 'Activity' %}</a></li>
  </ul>
</div>

{% endblock %}

{% block document_head %}{% endblock %}

{% block document %}
<div id="review" class="span9 view default">
    <div class="doc-body">
        <span id="document-md">{{ document_html|default:""|safe }}</span>
    </div>
</div>

<div id="signatories" class="span9 view hide">
    <h2 class="title">{% trans 'Signatories' %}</h2>
    <div id="invite-to-sign" data-can_add_invite="true" class="">&nbsp;</div>
    <div class="doc-body">
        {% invitee_detail_list invitee_list %}
    </div>
    <div id="signature-preview">{{ signature }}</div>
</div>

<div id="comments" class="span9 view hide">
    <h2 class="title">{% trans 'Comments' %}</h2>
      <div id="document-comments" class="doc-body">
      {% comments_for_object userdoc next %}
      </div>
</div>

<div id="activity" class="span9 view hide">
    <h2 class="title">{% trans 'Activity' %}</h2>
    <div class="doc-body">
      <ul class="activity activity-large">
      {% document_activity_stream document=userdoc limit=50 %}
      </ul>
    </div>
</div>

<div id="qr" class="span9 view hide">
    <h2 class="title">{% trans 'Document QR Code' %}</h2>
    <p>Download and share this QR code to link to this document</p>
    <div class="doc-body">
      <img src="{% url 'document:qr_code' pk=userdoc.pk %}" />
    </div>
</div>
{% endblock %}

{% block css %}{% endblock %}

{% block js %}

<script>
$(document).ready(function(){
    var app = $.sammy(function() {
        var self = this;

        self.views = $('div.view');
        self.nav = $('ul.nav-list li a');

        var hb_templates_source   = $("script#template_list").html();
        var hb_templates_list = Handlebars.compile(hb_templates_source);

        this.get('#/', function() {
            this.redirect('#/review');
        });

        this.get('#/review', function() {
            self.show($('div#review'));
        });
        this.get('#/review/signatories', function() {
            self.show($('div#signatories'));
        });
        this.get('#/review/comments', function() {
            self.show($('div#comments'));
        });
        this.get('#/review/activity', function() {
            self.show($('div#activity'));
        });
        this.get('#/review/qr', function() {
            self.show($('div#qr'));
        });
    
        this.hide_all = function hide_all() {
            self.nav.removeClass('selected');
            $.each(self.views, function(index, item) {
                $(item).hide();
            });
        };

        this.show = function show(view_list) {
            if ($.isArray(view_list) == false) {
                view_list = [view_list];
            }
            self.hide_all();
            $('[href="'+window.location.hash+'"]').addClass('selected');
            $.each(view_list, function(index, item) {
                item.show();
            });
        }

    });

    // start the application
    app.run('#/');

    $.each($('.signaturePad'), function(index, item) {
      item = $(item);
      var sig = $('#' + item.attr('rel'))
      item.signaturePad({displayOnly:true}).regenerate(sig.html());
    });


});
</script>
{% invite_to_sign userdoc '#invite-to-sign' %}
{% endblock %}