{% load i18n markup templatetag_handlebars %}
{% load url from future %}

{% tplhandlebars "hb-signatory-detail" %}
<form class="form-horizontal">
  <fieldset class="Invitee">
  <div id="" class="control-group">
  {{#with invitee}}
  <input type="hidden" id="id_detail-index" name="detail-index" value="{{index}}" />
  <label for="detail-name">{% trans 'Name' %}:</label> <input type="text" id="id_detail-name" name="detail-name" value="{{name}}" />
  <label for="detail-email">{% trans 'Email' %}:</label> <input type="text" id="id_detail-email" name="detail-email" value="{{email}}" />
  {{/with}}
  </div>
  </fieldset>
  <div class="form-actions">
      <button id="detail-done" type="button" class="submit btn btn-primary">{% trans 'Done' %}</button>
  </div>
</form>
{% endtplhandlebars %}

{% tplhandlebars "hb-invite-signatories" %}
<div id="invite-signatories">
  <a id="" class="signatory_add">invite another</a>
  <span class="message">{{message}}</span>
  <form id="send-invite" class="form-horizontal">
    <input type="hidden" name="csrfmiddlewaretoken" value="{{csrf_token}}" />
    <ul id="invitees">
    {{#each invitees}}
    <li class="{{#if has_signed}}has_signed{{/if}}">
      <input type="hidden" id="id_list-name" name="name" value="{{name}}" />
      <input type="hidden" id="id_list-email" name="email" value="{{email}}" />
      {{#if profile_picture}}<img class="{{#if has_signed}}has_signed{{/if}}" src="" data-postload_src="{{profile_picture}}" />{{/if}}
      <i class="icon-remove signatory_remove" data-index_lookup="{{email}}"></i>
      <a class="signatory_detail" data-index_lookup="{{email}}" title="{{email}}" href="">{{name}}</a> 
    </li>
    {{/each}}
    </ul>
    <button id="submit-invitation" type="submit" class="btn btn-success btn-mini">{% trans 'Send Invitation' %}</button>
  </form>
</div>
{% endtplhandlebars %}

<script type="text/javascript">
$(document).ready(function(){
//  console.log('{{target_element}}')

  inviteToSignWidget = function inviteToSignWidget(params) {
    var self = this;
    self.csrf_token = App.getCSRFToken();
    self.target_element = params['target_element'];
    self.compiledTemplate = Handlebars.compile($('#hb-invite-signatories').html());
    self.compiledDetailTemplate = Handlebars.compile($('#hb-signatory-detail').html());
    self.inviteForm = 'form#send-invite';
    self.context = params;
    self.context['csrf_token'] = self.csrf_token.val();
    self.context['invitees'] = (params['invitees'] != undefined) ? params['invitees']: [];

    self.add = function add(email, name, profile_picture, has_signed) {
      self.context['invitees'].push({'email': email, 'name': name, 'profile_picture': profile_picture, 'has_signed': has_signed})
      self.render();
    };

    self.update = function update(index, name, email) {
      item = self.context['invitees'][index];
      if (item == undefined) {
        // new
        profile_picture = '';// url to grayman
        self.context['invitees'].push({'email': email, 'name': name, 'profile_picture': profile_picture})
      } else {
        // old
        self.context['invitees'][index] = {'email': email, 'name': name, 'profile_picture': item.profile_picture};
      }
      self.render();
    };

    self.showDetailView = function showDetailView(email) {
      var selectedItem = {};
      if (email != undefined) {
        $.each(self.context['invitees'], function(index, item){
          if (item.email == email) {
            item['index'] = index;
            selectedItem = item;
            return false;
          }
        });
      };
      $( "#signatory-detail" ).html(self.compiledDetailTemplate({'invitee': selectedItem}));
      $( "#signatory-detail" ).dialog('open');
    };

    self.remove = function remove(email) {
      $.each(self.context['invitees'], function(index, item){
        if (item.email == email) {
          self.context['invitees'].splice(index, 1);
          return false;
        }
      });
      self.render();
    };

    self.isValidEmail = function isValidEmail(email) {
        var filter = /^([\w-\.\+]+)@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([\w-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)$/;
        if (filter.test(email)) {
          return true;
        } else {
          return false;
        }
    };

    self.render = function render() {
      self.target_element.html(self.compiledTemplate(self.context));
    };

    self.sendInvitation = function sendInvitation() {
      var form = $(self.inviteForm);
      $.ajax({
        type: 'POST',
        url: "{% url 'sign:invite' pk=document.pk %}",
        data: form.serialize(),
      })
      .success(function(data, textStatus, jqXHR) {
          var response_data = $.parseJSON(data);
        self.context['message'] = 'success';
      })
      .error(function(jqXHR, textStatus, errorThrown) { 
        self.context['message'] = 'Error: ' + errorThrown;
      })
      .complete(function(jqXHR, textStatus) {
        self.render();
      });
    };

    self.setupInterface = function setupInterface() {
      $('#submit-invitation').live('click', function(event){
          event.preventDefault();
          self.sendInvitation();
      });
      $('.signatory_add').live('click', function(event){
          event.preventDefault();
          self.showDetailView();
      });
      $('.signatory_detail').live('click', function(event){
          event.preventDefault();
          self.showDetailView($(this).attr('data-index_lookup'));
      });
      $('.signatory_remove').live('click', function(event){
          event.preventDefault();
          self.remove($(this).attr('data-index_lookup'));
      });
      $("div#signatory-detail").dialog({
        title: '{% trans "Invitee" %}',
        width: 440,
        height: 330,
        modal: true
      });
      $("div#signatory-detail").dialog('close');
      $('button#detail-done').live('click', function(event){
          event.preventDefault();
          var control_group = $(this).closest('form');
          index = control_group.find('[name=detail-index]').val();
          name = control_group.find('[name=detail-name]').val();
          email = control_group.find('[name=detail-email]').val();
          if (name != '' && email != '' && self.isValidEmail(email)) {
            self.update(index, name, email);
            $("div#signatory-detail").dialog('close');
          } else {
            if (name == '' && email == '') {
              $("div#signatory-detail").dialog('close');
            }
          }

      });

    };

    self.argosPanOptiaCallback = function argosPanOptiaCallback(contact_ob) {
      self.add(contact_ob.email, contact_ob.name, contact_ob.profile_picture, false);
    };

    self.init = function init(params) {
      self.target_element = params['target_element'];
      self.setupInterface();

      App.registerCallback('invitee.add', self.argosPanOptiaCallback);

      self.render();
    };

    self.init(params);
  };

  inviteToSign = new inviteToSignWidget({'target_element': $('{{ target_element }}')});
  inviteToSign.add('ross@weareml.com','Ross Crawford','')

});
</script>