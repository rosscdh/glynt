{% extends 'client/base.html' %}
{% load url from future %}
{% load i18n %}

{% block body %}

<div class="row">
  <div class="span12">
    <h2>New Document
      <small>Documents available to create</small>
      </h2>
      <br />

	<div id="myCarousel" class="carousel slide">
	  <!-- Carousel items -->
	  <div class="carousel-inner offset1">
		<div class="active item row contracts">
			{% for d in public_document_list %}
	            <div class="span2" style="background-color:#{% cycle 'fbd534' '58c4ea' '76c58c' 'f098a4' '5bcaf8' 'c0d72f' %}"><a class="template-document" href="{% url 'document:view' slug=d.slug %}">{{ d.name }}</a></div>
				{% cycle '' '' '' '</div><div class="item row contracts">' %}
            {% endfor %}

        </div>
	  </div>
	  <!-- Carousel nav -->
	  <a class="carousel-control left" href="#myCarousel" data-slide="prev">&lsaquo;</a>
	  <a class="carousel-control right" href="#myCarousel" data-slide="next">&rsaquo;</a>
	</div>
  </div>
</div>
<hr/>
<div class="row">
        <div class="span12">
                <h2>Your Documents
                    <small>All of your generated documents</small>
                </h2>
                <br />
				<div class="row">
					<div class="span3">
	                	<ul class="nav nav-list">
		                  <li class="active">
		                    <a href="#">All Documents</a>
		                  </li>
		                  <li><a href="#">Incomplete Documents</a></li>
		                </ul>
					</div>
					<div class="span9">
                         <table id="my-documents" class="table table-stripped table-border table-hover">
                     		{% for d in my_document_list %}
                             <tr>
								<td class="span5">
                                  <h3><a href="{% url 'document:my_view' slug=d.slug %}">{{ d.name }}</a></h3>
                                </td>
								<td>
									<div class="btn-group pull-right">
	                                   <a href="{% url 'document:my_view' slug=d.slug %}" class="btn btn-info">{% trans 'Edit' %}</a>
	                                   <a id="clone-{{ d.pk }}" href="#clone" data-url="{% url 'document:my_clone' pk=d.pk %}" data-pk="{{ d.pk }}" class="clone-my-document btn btn-info">{% trans 'Clone' %}</a>
	                                   <a id="export-{{ d.pk }}" href="#export" data-url="{% url 'document:export' slug=d.slug %}" data-pk="{{ d.pk }}" class="export-pdf btn btn-success">{% trans 'Download PDF' %}</a>
                                   		<a id="delete-{{ d.pk }}" href="#delete" data-url="{% url 'document:my_delete' pk=d.pk %}" data-pk="{{ d.pk }}" class="delete-my-document btn btn-error">{% trans 'Delete' %}</a>
							        </div>                                 
							   </td>
                             </tr>
                          {% endfor %}
                         </table>
					</div>
				</div>
        </div>
</div>
{% endblock %}


{% block js %}
<script id="document-controls" type="text/javascript">
$(document).ready(function(){

  $('a.export-pdf').live('click', function(event){
    event.preventDefault();
    var data = {
        csrfmiddlewaretoken: '{{ csrf_raw_token }}',
        md: '',
        id: $(this).attr('data-pk')
    };
    console.log($(this).attr('data-url'))
    $.ajax({
      type: 'POST',
      url: $(this).attr('data-url'),
      data: data,
    })
    .success(function(data, textStatus, jqXHR) {
        data = data[0];
        var filename = data.filename;
        window.open(filename, 'pdf');
    })
    .error(function() { 
        console.log('Error in Javascript event')
    })
    .complete(function() {
    });
  });

  deleted_doc = null;

  $('a.delete-my-document').live('click', function(event){
    event.preventDefault();
    var self = $(this);
    var data = {
        csrfmiddlewaretoken: '{{ csrf_raw_token }}'
    };
    $.ajax({
      type: 'POST',
      url: $(this).attr('data-url'),
      data: data,
    })
    .success(function(data, textStatus, jqXHR) {
      data = data[0];
      var li = self.closest('li');
      var div = li.find('div');
      deleted_doc = div;
      div.fadeOut('slow', function(){
        $(this).remove();
        li.html(data.message);
      });

    })
    .error(function(jqXHR, textStatus, errorThrown) { 
      console.log(jqXHR)
      console.log(textStatus)
      console.log(errorThrown)
      console.log('Error in Javascript event')
    })
    .complete(function() {
    });
  });

  $('a.clone-my-document').live('click', function(event){
    event.preventDefault();
    var self = $(this);
    var data = {
        csrfmiddlewaretoken: '{{ csrf_raw_token }}'
    };
    $.ajax({
      type: 'POST',
      url: $(this).attr('data-url'),
      data: data,
    })
    .success(function(data, textStatus, jqXHR) {
      data = data[0];
      window.location = data.url
    })
    .error(function(jqXHR, textStatus, errorThrown) { 
      console.log(jqXHR)
      console.log(textStatus)
      console.log(errorThrown)
      console.log('Error in Javascript event')
    })
    .complete(function() {
    });
  });

  $('a.undelete-my-document').live('click', function(event){
    event.preventDefault();

    var self = $(this);
    var data = {
        csrfmiddlewaretoken: '{{ csrf_raw_token }}'
    };
    $.ajax({
      type: 'POST',
      url: $(this).attr('href'),
      data: data,
    })
    .success(function(data, textStatus, jqXHR) {
      data = data;
      var li = self.closest('li');
      li.html($(deleted_doc).show());
      $(deleted_doc).children().show();
      console.log(deleted_doc)

    })
    .error(function(jqXHR, textStatus, errorThrown) { 
      console.log(jqXHR)
      console.log(textStatus)
      console.log(errorThrown)
      console.log('Error in Javascript event')
    })
    .complete(function() {
    });
  });


});
</script>
{% endblock %}