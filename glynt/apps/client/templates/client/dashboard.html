{% extends 'client/base.html' %}
{% load i18n humanize %}
{% load activity %}
{% load templatetag_handlebars %}
{% load url from future %}

{% block bodyclass %}dashboard{% endblock %}


{% block body %}
<div class="row">

      <div class="span2 sidebar">
          <ul class="nav nav-list">
            <li><a href="#/list/templates/create_new" class="btn btn-green" id="toggle-docs">{% trans 'New Doc' %}</a></li>
            <li class="divider"></li>
              <li><a href="#/list/my_documents/all"> {% trans 'All Documents' %}</a></li>
            <li class="divider"></li>
              <li><a href="#/list/activity"> {% trans 'Activity' %}</a></li>
            <li class="divider"></li>
            <li class="nav-header">{% trans 'Your Document Filters' %}</li>
              <li><a href="#/list/my_documents/incomplete">{% trans 'Incomplete Documents' %}</a></li>
              <li><a href="#/list/my_documents/out_for_signing"> {% trans 'Out for signing' %}</a></li>
              <li><a href="#/list/my_documents/recently_signed">{% trans 'Recently signed' %}</a></li>
              <li><a href="#/list/my_documents/awaiting_your_signature">{% trans 'Awaiting your signature' %}</a></li>
          </ul>
      </div>

      <div id="my_docs_list" class="span7 view default">
        <div class="doc-body">
          <h2 class="title">{% trans 'Your Documents' %}</h2>
          <table id="my-documents" class="table table-stripped table-border table-hover">
          <tr>
              <th>Document Name</th>
              <th>Created</th>
              <th>Status</th>
              <th>Action</th>
          </tr>
          {% for d in my_document_list %}
          <tr>
              <td class="">
                <input type="checkbox"></input> <a href="{% url 'document:my_view' slug=d.slug %}" class="doc-title">{{ d.name }}</a><span class="label" style="float:right;margin-top:3px;opacity:0.6">{{ d.owner.get_profile.short_name|default:d.owner.username }}</span>
              </td>
              <td class="created">Created {{ d.created_at|naturaltime }}</td>
              <td>
                {{ d.num_signed }} / {{ d.num_invited }}
                {% cycle '<a href="#" class="btn btn-mini"><i class="icon-repeat"></i> Out for signing' '<a href="#" class="btn btn-mini btn-green"><i class="icon-ok icon-white"></i> Signed' '<a href="#" class="btn btn-red btn-mini"><i class="icon-pencil icon-white"></i> Please sign' %}</a></td>
              <td>
                <div class="btn-group pull-right">
                  <button class="btn dropdown-toggle" data-toggle="dropdown"><i class="icon-cog"></i> <span class="caret"></span></button>
                  <ul class="dropdown-menu">
                    <li><a id="clone-{{ d.pk }}" href="#clone" data-url="{% url 'document:my_clone' pk=d.pk %}" data-pk="{{ d.pk }}" class="clone-my-document">{% trans 'Clone' %}</a></li>
                    <li><a id="export-{{ d.pk }}" href="{% url 'document:export' slug=d.slug %}" target="_BLANK" data-url="{% url 'document:export' slug=d.slug %}" data-pk="{{ d.pk }}" class="">{% trans 'Download PDF' %}</a></li>
                    <li><a id="delete-{{ d.pk }}" href="#delete" data-url="{% url 'document:my_delete' pk=d.pk %}" data-pk="{{ d.pk }}" class="delete-my-document">{% trans 'Delete' %}</a></li>
                  </ul>
                </div>
              </td>
          </tr>
          {% endfor %}
          </table>
        </div>
      </div>

      <div id="activity_list" class="span7 view hide">
        <div class="doc-body">
          <h3>{% trans 'Activity' %}</h3>
          <ul class="activity activity-large">
          {% user_activity_stream request.user 50 %}
          </ul>
        </div>
      </div>

      <div id="templates_list" class="span7 view hide">
        <div class="doc-body">
          <h2>{% trans 'New Document' %}</h2>
          <ul>
            {% for d in public_document_list %}
            <li><a class="template-document" href="{% url 'document:view' slug=d.slug %}">{{ d.name }}</a></li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <div class="span3 pull-right">
        <div class="doc-body">
          <h4>{% trans 'Recent Activity' %}</h4>
          <ul class="activity activity-small">
          {% user_activity_stream request.user 3 %}
          </ul>
        </div>
      </div>
</div>
{% endblock %}

{% block css %}
<style>
ul.activity{
  margin:0px;
  padding:0px;
  list-style: none;
}
ul.activity li{
  padding:5px 0px;
  border-bottom:solid #ccc 1px;
}
ul.activity li:last{
  border:0px;
}
</style>
{% endblock %}

{% block js %}
<script id="document-templates" type="text/javascript">
[{% for d in public_document_list %}{"id": "{{ d.slug }}", "text": "{{ d.name }}", "url":"{% url 'document:view' slug=d.slug %}", "color": "#{% cycle 'fbd534' '58c4ea' '76c58c' 'f098a4' '5bcaf8' 'c0d72f' %}"}{% if not forloop.last %}, {% endif %}{% endfor %}]
</script>

{% tplhandlebars "document-template-item" %}
<div class="span2" style="background-color:{{color}}"><a class="template-document" href="{{url}}">{{text}}</a></div>
{% endtplhandlebars %}

<script id="document-controls" type="text/javascript">
$(document).ready(function(){
// ----- Document Template Select -----
var app = $.sammy(function() {
    var self = this;
    self.views = $('div.view');
    self.nav = $('ul.nav-list li a');

    // var hb_source   = $("#people").html();
    // var hb_template = Handlebars.compile(hb_source);

    this.get('#/', function() {
        this.redirect('#/list/my_documents/all');
    });

    this.get('#/list/my_documents/all', function() {
        self.show($('div#my_docs_list'));
    });
    this.get('#/list/my_documents/incomplete', function() {
        self.show($('div#my_docs_list'));
    });
    this.get('#/list/my_documents/out_for_signing', function() {
        self.show($('div#my_docs_list'));
    });
    this.get('#/list/my_documents/recently_signed', function() {
        self.show($('div#my_docs_list'));
    });
    this.get('#/list/my_documents/awaiting_your_signature', function() {
        self.show($('div#my_docs_list'));
    });

    this.get('#/list/activity', function() {
        self.show($('div#activity_list'));
    });

    this.get('#/list/templates/create_new', function() {
        self.show($('div#templates_list'));
    });

    this.hide_all = function hide_all() {
        self.nav.removeClass('active');
        $.each(self.views, function(index, item) {
            $(item).hide();
        });
    };
    this.show = function show_view(view_list) {
        if ($.isArray(view_list) == false) {
            view_list = [view_list];
        }
        self.hide_all();
        $('ul.nav-list li a [href="'+window.location.hash+'"]').addClass('active');
        $.each(view_list, function(index, item) {
            item.show();
        });
    }
    
});

// start the application
app.run('#/');

$("#document-template-search").select2({
    query: function(options) {
      if (this.template == undefined) {
        this.template = Handlebars.compile($('#document-template-item').html());
      }
      $('#carousel').hide();
      $('#template-list').html('');
      for (i in this.data) {
        object = this.data[i];
        if (object.text.toLowerCase().indexOf(options.term.toLowerCase()) != -1) {
          result = this.template(object);
          result = $(result);
          result.hide();
          $('#template-list').append(result);
          result.fadeIn('slow');
        }
      };
      return null;
    },
    width: '100%',
    minimumInputLength: 2,
    multiple: false,
    data: $.parseJSON($('#document-templates').html())
});

// ----- My Document list options -----
  $('a.export-pdf').live('click', function(event){
    event.preventDefault();
    var data = {
        csrfmiddlewaretoken: '{{ csrf_raw_token }}',
        md: '',
        id: $(this).attr('data-pk')
    };

    $.ajax({
      type: 'POST',
      url: $(this).attr('data-url'),
      data: data,
    })
    .success(function(data, textStatus, jqXHR) {
      console.log(data)
    })
    .error(function() { 
        console.log('Error in Javascript event')
    })
    .complete(function() {
    });
  });

  deleted_doc = null;

  $('a.delete-my-document').live('click', function(event){
    event.preventDefault();
    var self = $(this);
    var data = {
        csrfmiddlewaretoken: '{{ csrf_raw_token }}'
    };
    $.ajax({
      type: 'POST',
      url: $(this).attr('data-url'),
      data: data,
    })
    .success(function(data, textStatus, jqXHR) {
      data = data[0];
      var div = self.closest('div');
      var td = self.closest('td');
      var tr = self.closest('tr');
      deleted_doc = td.html()
      div.fadeOut('slow', function(){
        $(this).remove();
        td.html(data.message);
      });

    })
    .error(function(jqXHR, textStatus, errorThrown) { 
      console.log(jqXHR)
      console.log(textStatus)
      console.log(errorThrown)
      console.log('Error in Javascript event')
    })
    .complete(function() {
    });
  });

  $('a.undelete-my-document').live('click', function(event){
    event.preventDefault();

    var self = $(this);
    var data = {
        csrfmiddlewaretoken: '{{ csrf_raw_token }}'
    };
    $.ajax({
      type: 'POST',
      url: $(this).attr('href'),
      data: data,
    })
    .success(function(data, textStatus, jqXHR) {
      data = data;

      var div = self.closest('div');
      var td = self.closest('td');
      var tr = self.closest('tr');

      td.html(deleted_doc);
      $(deleted_doc).children().show();

    })
    .error(function(jqXHR, textStatus, errorThrown) { 
      console.log(jqXHR)
      console.log(textStatus)
      console.log(errorThrown)
      console.log('Error in Javascript event')
    })
    .complete(function() {
    });
  });

  $('a.clone-my-document').live('click', function(event){
    event.preventDefault();
    var self = $(this);
    var data = {
        csrfmiddlewaretoken: '{{ csrf_raw_token }}'
    };
    $.ajax({
      type: 'POST',
      url: $(this).attr('data-url'),
      data: data,
    })
    .success(function(data, textStatus, jqXHR) {
      data = data[0];
      window.location = data.url
    })
    .error(function(jqXHR, textStatus, errorThrown) { 
      console.log(jqXHR)
      console.log(textStatus)
      console.log(errorThrown)
      console.log('Error in Javascript event')
    })
    .complete(function() {
    });
  });


});
</script>
{% endblock %}