{% extends 'client/base.html' %}
{% load url from future %}
{% load i18n %}
{% load templatetag_handlebars %}

{% block body %}
<div class="row">
  <div class="span12">
    <h2>New Document<br/><small>Search for a Document Template</small></h2>
    <br />
    <!-- Select2 items -->
    <input type="hidden" multiple id="document-template-search" name="" value=""/>
    <br /><br /><br /><br />
    <div id="template-list" class="row contracts hidden"></div>
    <div id="carousel" class="carousel slide">
      <!-- Carousel items -->
      <div class="carousel-inner offset1">
        <div class="active item row contracts">
        {% for d in public_document_list %}
        <div class="span2" style="background-color:#{% cycle 'fbd534' '58c4ea' '76c58c' 'f098a4' '5bcaf8' 'c0d72f' %}"><a class="template-document" href="{% url 'document:view' slug=d.slug %}">{{ d.name }}</a></div>
        {% cycle '' '' '' '</div><div class="item row contracts">' %}
        {% endfor %}
        </div>
      </div>
      <!-- Carousel nav -->
      <a class="carousel-control left" href="#carousel" data-slide="prev">&lsaquo;</a>
      <a class="carousel-control right" href="#carousel" data-slide="next">&rsaquo;</a>
    </div>
  </div>
</div>

<hr/>

<div class="row">
  <div class="span12">
    <h2>Your Documents
        <small>All of your generated documents</small>
    </h2>
    <br />
    <div class="row">
    <div class="span3">
      <ul class="nav nav-list">
        <li class="active">
          <a href="#">All Documents</a>
        </li>
        <li><a href="#">Incomplete Documents</a></li>
      </ul>
    </div>
    <div class="span9">
      <table id="my-documents" class="table table-stripped table-border table-hover">
      {% for d in my_document_list %}
      <tr>
        <td class="span5">
          <h3><a href="{% url 'document:my_view' slug=d.slug %}">{{ d.name }}</a></h3>
        </td>
        <td>
          <div class="btn-group pull-right">
          <a href="{% url 'document:my_view' slug=d.slug %}" class="btn btn-info">{% trans 'Edit' %}</a>
          <a id="clone-{{ d.pk }}" href="#clone" data-url="{% url 'document:my_clone' pk=d.pk %}" data-pk="{{ d.pk }}" class="clone-my-document btn btn-info">{% trans 'Clone' %}</a>
          <a id="export-{{ d.pk }}" href="#export" data-url="{% url 'document:export' slug=d.slug %}" data-pk="{{ d.pk }}" class="export-pdf btn btn-success">{% trans 'Download PDF' %}</a>
          <a id="delete-{{ d.pk }}" href="#delete" data-url="{% url 'document:my_delete' pk=d.pk %}" data-pk="{{ d.pk }}" class="delete-my-document btn btn-error">{% trans 'Delete' %}</a>
          </div>                                 
        </td>
      </tr>
      {% endfor %}
      </table>
    </div>
  </div>
  </div>
</div>
{% endblock %}


{% block js %}
<script id="document-templates" type="text/javascript">
[{% for d in public_document_list %}{"id": "{{ d.slug }}", "text": "{{ d.name }}", "url":"{% url 'document:view' slug=d.slug %}", "color": "#{% cycle 'fbd534' '58c4ea' '76c58c' 'f098a4' '5bcaf8' 'c0d72f' %}"}{% if not forloop.last %}, {% endif %}{% endfor %}]
</script>

{% tplhandlebars "document-template-item" %}
<div class="span2" style="background-color:{{color}}"><a class="template-document" href="{{url}}">{{text}}</a></div>
{% endtplhandlebars %}

<script id="document-controls" type="text/javascript">
$(document).ready(function(){
// ----- Document Template Select -----

$("#document-template-search").select2({
    query: function(options) {
      if (this.template == undefined) {
        this.template = Handlebars.compile($('#document-template-item').html());
      }
      $('#carousel').hide();
      $('#template-list').html('');
      for (i in this.data) {
        object = this.data[i];
        if (object.text.toLowerCase().indexOf(options.term.toLowerCase()) != -1) {
          result = this.template(object);
          result = $(result);
          result.hide();
          $('#template-list').append(result);
          result.fadeIn('slow');
        }
      };
      return null;
    },
    width: '100%',
    minimumInputLength: 2,
    multiple: false,
    data: $.parseJSON($('#document-templates').html())
});

// ----- My Document list options -----
  $('a.export-pdf').live('click', function(event){
    event.preventDefault();
    var data = {
        csrfmiddlewaretoken: '{{ csrf_raw_token }}',
        md: '',
        id: $(this).attr('data-pk')
    };

    $.ajax({
      type: 'POST',
      url: $(this).attr('data-url'),
      data: data,
    })
    .success(function(data, textStatus, jqXHR) {
      console.log(data)
    })
    .error(function() { 
        console.log('Error in Javascript event')
    })
    .complete(function() {
    });
  });

  deleted_doc = null;

  $('a.delete-my-document').live('click', function(event){
    event.preventDefault();
    var self = $(this);
    var data = {
        csrfmiddlewaretoken: '{{ csrf_raw_token }}'
    };
    $.ajax({
      type: 'POST',
      url: $(this).attr('data-url'),
      data: data,
    })
    .success(function(data, textStatus, jqXHR) {
      data = data[0];
      var div = self.closest('div');
      var td = self.closest('td');
      var tr = self.closest('tr');
      deleted_doc = td.html()
      div.fadeOut('slow', function(){
        $(this).remove();
        td.html(data.message);
      });

    })
    .error(function(jqXHR, textStatus, errorThrown) { 
      console.log(jqXHR)
      console.log(textStatus)
      console.log(errorThrown)
      console.log('Error in Javascript event')
    })
    .complete(function() {
    });
  });

  $('a.undelete-my-document').live('click', function(event){
    event.preventDefault();

    var self = $(this);
    var data = {
        csrfmiddlewaretoken: '{{ csrf_raw_token }}'
    };
    $.ajax({
      type: 'POST',
      url: $(this).attr('href'),
      data: data,
    })
    .success(function(data, textStatus, jqXHR) {
      data = data;

      var div = self.closest('div');
      var td = self.closest('td');
      var tr = self.closest('tr');

      td.html(deleted_doc);
      $(deleted_doc).children().show();

    })
    .error(function(jqXHR, textStatus, errorThrown) { 
      console.log(jqXHR)
      console.log(textStatus)
      console.log(errorThrown)
      console.log('Error in Javascript event')
    })
    .complete(function() {
    });
  });

  $('a.clone-my-document').live('click', function(event){
    event.preventDefault();
    var self = $(this);
    var data = {
        csrfmiddlewaretoken: '{{ csrf_raw_token }}'
    };
    $.ajax({
      type: 'POST',
      url: $(this).attr('data-url'),
      data: data,
    })
    .success(function(data, textStatus, jqXHR) {
      data = data[0];
      window.location = data.url
    })
    .error(function(jqXHR, textStatus, errorThrown) { 
      console.log(jqXHR)
      console.log(textStatus)
      console.log(errorThrown)
      console.log('Error in Javascript event')
    })
    .complete(function() {
    });
  });

});
</script>
{% endblock %}