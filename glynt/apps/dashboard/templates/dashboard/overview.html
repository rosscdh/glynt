{% extends 'base.html' %}{% load url from future %}{% load glynt_helpers crispy_forms_tags project_tags comments fluent_comments_tags jsonify %}

{% block page_title %}Overview &mdash; {% project_name project %}{% endblock %}

{% block header %}
    <!-- Page Header -->
    <div class="page-header">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <h1>Overview</h1>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block body %}
{% csrf_token %}
<!-- Button trigger modal -->
<div class="container dashboard-view" ng-controller="ProjectCtrl">
    {% if not profile_is_complete and user.profile.is_customer %}
        <div class="callout callout-danger empty">
            <div class="empty-message empty-message-exclamation-sign">
                <h3>We need some more information from you</h3>
                <p>We can't continue with your transaction until you tell us a bit more about your startup.</p>
                <a href="{% url 'transact:builder' project_uuid=project.uuid tx_range=project.tx_range step='1' %}" class="btn btn-primary">Click here to complete your profile</a>
            </div>
        </div>
    {% else %}
        {% if not project.has_lawyer and user.profile.is_customer %}
            {% project_lawyers project 'potential' %}
            <br />
        {% endif %}
        {% if counts.awaiting_feedback_from_user > 0 %}
            <div class="alert"><i class="glyphicon glyphicon-time"></i> You have one more checklist items awaiting feedback. Visit your checklist to respond to them.</div>
        {% endif %}
        <div class="row">
            <div class="col col-lg-5">
                {% if project.has_lawyer %}
                   <!--
                    <div class="widget account-attorney">
                        <h3>Project Attorney</h3>
                        {% project_lawyers project 'assigned' %}
                    </div>
                    //-->
                {% endif %}
                <!--
                <div class="widget account-attorney">
                    <h3>LawPal Account Manager</h3>
                    <div class="row">
                        <div class="col-12">
                            <img src="{{STATIC_URL}}img/yael-contact-face.jpg" class="img-circle pull-left" style="width:40px; padding-right :8px;padding-top:6px;">
                            <h4>Yael Citro <small class="pull-right"><a href="mailto:xw4ux8lx@incoming.intercom.io" class="btn btn-info btn-small intercom" style="margin-top:-4px">Contact Yael</a></small>  <small>Co-Founder at LawPal </small></h4>
                        </div>
                    </div>
                </div>
                //-->
                

                <div class="widget project-team clearfix">
                    <button class="btn btn-info btn-small pull-right widget-title-button" ng-click="openManageTeamDialog()">Edit team</button>
                    <h3>Project team</h3>
                    <button class="btn btn-link col-lg-4 vcard role-{[{user.role}]}" ng-repeat="user in data.project.users | filter: { is_deleted: false }" ng-click="contactUser(user)">
                        <div class="vcard-wrapper clearfix" tooltip-append-to-body="true" tooltip="{[{user.full_name}]} ({[{user.role}]}), contact now">
                            <img class="photo col-lg-4" ng-src="{[{user.photo}]}" />
                            <h3 class="col-lg-8">
                                <span ng-bind="user.full_name | firstLetters"></span>
                            </h3>
                        </div>
                    </button>
                </div>
                
                
                <div class="callout callout-success empty">
                    <div class="empty-message empty-message-ok">
                        <h4>Your transaction profile is complete.</h4>
                        {% if PROJECT_ENVIRONMENT == 'dev' %}<a href="{% url 'transact:builder' project_uuid=project.uuid tx_range=project.tx_range step='1' %}" class="">update</a>{% endif %}
                    </div>
                </div>
            </div>
            <div class="col col-lg-7">
                <div class="widget checklist">
                    <a href="{% url 'dashboard:checklist' uuid=project.uuid %}"><h3>Transaction Checklist</h3></a>
                    <div class="row">
                        <div class="col col-3 text-center">
                            <h1>
                                <a href="{% url 'dashboard:checklist' uuid=project.uuid %}" class="text-muted">{{ counts.new }}</a>
                            </h1>
                            <a href="{% url 'dashboard:checklist' uuid=project.uuid %}">
                                <small class="softer">New</small>
                            </a>
                        </div>
                        <div class="col col-3 text-center">
                            <h1>
                                <a href="{% url 'dashboard:checklist' uuid=project.uuid %}" class="text-info">{{ counts.open }}</a>
                            </h1>
                            <a href="{% url 'dashboard:checklist' uuid=project.uuid %}">
                                <small class="softer">Open</small>
                            </a>
                        </div>
                        <div class="col col-3 text-center">
                            <h1>
                                <a href="{% url 'dashboard:checklist' uuid=project.uuid %}" class="text-warning">{{ counts.awaiting_feedback_from_user }}</a>
                            </h1>
                            <a href="{% url 'dashboard:checklist' uuid=project.uuid %}">
                                <small class="softer">Feedback</small>
                            </a>
                        </div>
                        <div class="col col-3 text-center">
                            <h1>
                                <a href="{% url 'dashboard:checklist' uuid=project.uuid %}" class="text-success">{{ counts.closed }}</a>
                            </h1>
                            <a href="{% url 'dashboard:checklist' uuid=project.uuid %}">
                                <small class="softer">Closed</small>
                            </a>
                        </div>
                    </div>
                </div>
                {% if project.has_lawyer %}
                <div class="widget discuss">
                    <h3>Project Discussion</h3>
                    {% render_comment_form for project %}
                    {% render_comment_list for project %}
                </div>
                {% endif %}
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}
{% block css %}
    <style>
        main {background-color:#fbfbfb;}
        .widget {background-color:white;}
        .widget h3 {border-bottom:1px solid #f1f1f1;padding-bottom:8px;}
        .widget.discuss h3 {border-bottom:0px;padding-bottom:3px;}
    </style>
{% endblock %}


{% block js %}
<script>
    $(function () {
        $("[data-toggle='tooltip']").tooltip();
    });

    $(document).on( 'click', '[data-engage]', function (event) {
        event.preventDefault();

        var elem = $(this);
        var pk = elem.data('engage');
        var status = elem.data('status');
        var url = '/api/v1/project_lawyer/{pk}'.assign({'pk': pk});
        elem.fadeOut();

        $.ajax({
            type: 'PATCH',
            url: url,
            data: JSON.stringify({'status': status }),
            dataType: 'application/json',
            contentType: 'application/json',
            beforeSend: function (jqXHR, settings) {
                // Pull the token out of the DOM.
                jqXHR.setRequestHeader('X-CSRFToken', $('input[name=csrfmiddlewaretoken]:first').val());
            },
            complete: function () {
                // reload the page to show updated lawyer info
                document.location.reload();
            }
        });
    });
</script>

<script type="text/javascript" src="{{ STATIC_URL }}dashboard/angularjs-projectCtrl.js"></script>

<script type="text/javascript">
var LawPal = {
        /* @HEY ROSS: /api/v2/project/:uuid/ */
        "project": function() {
            return {
                "name": "Fantastic startup",
                "uuid": "{{ project.uuid }}",
                "content_type_id": {{ project.content_type_id|default:None|jsonify }}
            }
        },
        "user": {
            'pk': {{ user.pk|default:'null'|jsonify }},
            'email': {{ user.email|default:'null'|jsonify }},
            'username': '{{ user.username }}',
            'full_name': '{{ user.get_full_name }}',
            'is_authenticated': {{ user.is_authenticated|jsonify }},
        }
};
</script>
<toaster-container toaster-options="{'time-out': 3000}"></toaster-container>
<script type="text/ng-template" id="manageTeam.html">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Project team</h3>
                <p>Primary project contacts can add and remove team members</p>
            </div>
            <div class="modal-body">
                <div class="row vcard team-member {[{isRemovedClass(user)}]}" ng-repeat="user in team">
                    <div class="col col-lg-12">
                        <div class="col col-lg-1 photo">
                            <img ng-src="{[{user.photo}]}"/>
                        </div>
                        <div class="col col-lg-7 details">
                            <h5 class="fn">{[{user.full_name}]}</h5>
                            <h6 class="company"><a href="/profile/{[{user.company.slug}]}">{[{user.company.name}]}</a></h6>
                        </div>
                        <div class="col col-lg-4 details">
                            <p class="action pull-right" ng-show="canRemove(user)">
                                <a href="javascript:;" ng-click="removeUser(user)" ng-show="!user.is_deleted"><i class="icon icon-remove text-danger"></i> Remove</a>
                                <a href="javascript:;" ng-click="removeUser(user)" ng-show="user.is_deleted"><i class="icon icon-undo"></i> Undo remove</a>
                            </p>
                        </div>
                    </div>

                </div><!-- row //-->
                <form class="form-search form-horizontal">
                    <div class="row">
                        <div class="col col-lg-12">
                            <h4>Add someone</h4>
                            <p class="help-block">You can only add people that have registered with LawPal at this time.</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col col-lg-8">
                            <input 
                                type="text" 
                                class="form-control search-query pull-left searching-{[{searchingEmail}]}" 
                                placeholder="Email address" 
                                typeahead="item.email for item in searchEmails($viewValue)" 
                                typeahead-wait-ms="600"
                                typeahead-min-length="3"
                                typeahead-loading="searchingEmail"
                                ng-model="searchAttrs.selectedEmail" />
                        </div>
                        <div class="col col-lg-4">
                            <button type="submit" class="btn btn-default" ng-click="addToProject(searchAttrs.selectedEmail, emailSearchResults)" ng-disabled="searchingEmail"><i class="icon {[{emailSearchClass(searchingEmail)}]}"></i> Add to project</button>
                        </div>
                            
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-default" ng-click="cancel()">Cancel</button>
                <button class="btn btn-primary" ng-click="ok()">Save</button>
            </div>
        </div>
    </div>

</script>

<script type="text/ng-template" id="profileDialog.html">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button class="close" ng-click="cancel()">&times;</button>
                <h3>{[{user.full_name}]}</h3>
                <h4 class="text-muted">{[{user.company}]} {[{user.position}]}</h4>
            </div>
            <div class="modal-body">
               <div class="row profile-details clearfix">
                    <div class="col col-lg-4 text center">
                        <img ng-src="{[{user.photo}]}" alt="{[{user.full_name}]}" />
                    </div>
                    <div class="col col-lg-8">
                        <div class="firm" ng-show="user.years_practiced">
                            <h2>{[{user.years_practiced}]} Years Practicing</h2>
                        </div>

                        <h5 class="bio">
                            {[{user.summary}]}
                        </h5>

                        <ul class="list-unstyled">
                            <li>
                                <i class="icon icon-envelope"></i>
                                <a href="mailto:{[{user.email}]}" class="btn btn-link" target="_blank">
                                    {[{user.full_name}]}
                                </a>
                            </li>

                            <li ng-show="user.phone">
                                <i class="icon icon-phone"></i>
                                <a href="skype:{[{user.phone}]}" class="btn btn-link">
                                    {[{user.phone}]}
                                </a>
                            </li>
                        </ul>

                        <a class="btn btn-success btn-large" ng-show="user.is_authenticated" href="/lawyers/profile/setup/">
                            <i class="icon-pencil"></i>
                            Edit profile
                        </a>
                    </div>
                </div>
                <div class="row softer" ng-show="user.practice_locations">
                    <div class="col-lg-12">
                        <hr />
                        <h2>Location</h2>
                    </div>
                </div>
                <div class="row">
                    <div ng-show="user.practice_locations" class="col col-lg-6" ng-repeat="location in user.practice_locations" style="background:url('//maps.googleapis.com/maps/api/staticmap?size=450x100&amp;markers=color:blue%7Clabel:S%7C{[{location}]}&amp;sensor=false');height:100px;background-position:center;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" ng-click="cancel()">Close</button>
            </div>
        </div>
    </div>

</script>

{% endblock %}